RTESO=mul inmul tmul mulm inadd # exp
ifndef RTES
RTES=${RTESO}
endif
MEANINGS=Modular_multiplication In_place_multiplication Multiplication In_place_modular_multiplication In_place_addition Modular_exponentiation

EXEC=${RTES:%=benchmark-recint_%}
WSRC=${EXEC:%=-W %.C}
OUTP=output.rint
MODEL=$(shell cat /proc/cpuinfo | grep "model name" | head -1|cut -d':' -f2| tr -s ' '|sed 's/^ //')

ifdef LOOPS
    OLOOPS=${LOOPS}
else
    OLOOPS=22
endif

SHELL := /bin/bash 
index = $(words $(shell a="$(2)";echo $${a/$(1)*/$(1)} ))
swap  = $(word $(call index,$(1),${RTESO}),${MEANINGS})
remun = $(shell a="$(1)";echo $${a}|sed 's/_/ /g')

SIZES=6 7 8 9 10 11 12 13
MONTG=MG_INACTIVE
PREFI=
THREADS=4

all: ${SIZES:%=all_%} ${SIZES:%=allmg_%} plot plotmg

mkplot = $(foreach fil, ${RTES}, sed 's/FUNCTION/${PREFI}${fil}/g;s/MODEL/${MODEL}/g;s/MEANING/$(call remun,$(call swap,${fil})) (${MONTG})/' generic.gnuplot > ${PREFI}${fil}.gnuplot; gnuplot  ${PREFI}${fil}.gnuplot;)

mkruns = make -j ${THREADS} "OPTFLAGS=-DSTD_RECINT_SIZE=$(1) -DMG_DEFAULT=${MONTG}" ${EXEC} ${WSRC}; $(foreach fil, ${RTES}, benchmark-recint_${fil} `echo '10^((${OLOOPS}-$(1))/2)'|bc` >> ${OUTP}.${PREFI}${fil};)

all_%:
	$(call mkruns,$*)
	
plot:
	$(call mkplot)

allmg_%: MONTG=MG_ACTIVE
allmg_%: PREFI=mg_
allmg_%:
	$(call mkruns,$*)

plotmg: MONTG=MG_ACTIVE
plotmg: PREFI=mg_
plotmg:
	$(call mkplot)